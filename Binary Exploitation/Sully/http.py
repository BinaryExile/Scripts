#!/usr/bin/env python
from sulley import *
import sys
import time

s_initialize("HTTP")



# Your mission: use Sulley syntax to describe the following request:
#  HEAD /index.html HTTP/1.1\r\n\r\n
# Use s_static, s_string and s_delim where appropriate
# Refer to course material for examples and reference for each function

#Using Groups
#s_group("verbs", values=["GET", "HEAD", "POST", "TRACE"])
#if s_block_start("body", group="verbs"):
        #s_delim(" ")
        #s_delim("/")
        #s_string("index.html")
        #s_delim(" ")
        #s_string("HTTP")
        #s_delim("/")
        #s_string("1")
        #s_delim(".")
        #s_string("1")
        #s_static("\r\n\r\n")
#s_block_end("body")        


#Minimal
s_static("HEAD /index.html")
s_string("HTTP")
s_static("/1.1\r\n\r\n")

print "Mutations: " + str(s_num_mutations())

#print "ASCII mutation output:"
#i=0
#while s_mutate():
#	print "Case: " + str(i) + ":\n"
#	print s_render()
#	print "\n\n"
#	i=i+1
#sys.exit()

print "Press CTRL/C to cancel in ",
for i in range(3):
	print str(3 - i) + " ",
	sys.stdout.flush()
	time.sleep(1)

print "Instantiating session"
sess = sessions.session(session_filename="http.session", sleep_time=0.25)

print "Instantiating target"
target = sessions.target("192.168.0.106", 80)
target.procmon = pedrpc.client("192.168.0.106", 26002)
target.netmon = pedrpc.client("127.0.0.1", 26001)

target.procmon_options =  {
	"proc_name" : "savant.exe",
	"stop_commands" : ['wmic process where (name="savant.exe") delete"'],
	"start_commands" : ['C:\\savant\\savant.exe'],
}


print "Adding target"
sess.add_target(target)

print "Building graph"
sess.connect(s_get("HTTP"))

print "Starting fuzzing now"
sess.fuzz()
